function content_loader_init(){arrPageContent.scroll_block_height=$(document).find(arrPageContent.scroll_block).prop("scrollHeight"),arrPageContent.from=0,parseInt(arrPageParams.from)&&(arrPageContent.from=arrPageParams.from),arrPageParams.scroll_block&&(arrPageContent.scroll_block=arrPageParams.scroll_block),parseInt(arrPageParams.parents)&&(arrPageContent.parents=arrPageParams.parents),parseInt(arrPageParams.id)&&(arrPageContent.id=arrPageParams.id),arrPageContent.scroll_nav=arrPageParams.scroll_nav?arrPageParams.scroll_nav:0,arrPageContent.full=!1,arrPageContent.table=arrPageParams.table,arrPageContent.sort=arrPageParams.sort,arrPageContent.sortdir=arrPageParams.sortdir,arrPageContent.form=arrPageParams.form,arrPageContent.limit=arrPageParams.limit?arrPageParams.limit:10,arrPageContent.elem_show_class=arrPageParams.elem_show_class,arrPageContent.content_selector=arrPageParams.content_selector,arrPageContent.elem_template_path=arrPageParams.elem_template_path,arrPageContent.elem_template_selector=arrPageParams.elem_template_selector,arrPageContent.oTemplate={},arrPageContent.elem_template_path&&$.get("templates/"+arrPageContent.elem_template_path).fail(function(e){app_status({error:"Шаблон не найден: "+sTemplatePath})}).done(function(e){e&&(arrPageContent.oTemplate=$("<div/>").html(e))}),arrPageContent.elem_template_selector&&(arrPageContent.oTemplate=$(document).find(arrPageContent.elem_template_selector)),$(document).find(arrPageContent.scroll_block).addClass("_scroll_").addClass("_top_"),content_loader_load("start"),content_loader_scroll_init()}function content_loader_scroll_init(){arrPageContent.scroll_block?$(document).find(arrPageContent.scroll_block).on("scroll",content_loader_scroll_load):(arrPageContent.scroll_block||(arrPageContent.scroll_block=$(window).width()>=920?"#main_block_content":"html, body"),$(window).width()>=920?$(document).find("#main_block_content").on("scroll",content_loader_scroll_load):$(window).bind("scroll",content_loader_scroll_load))}function content_loader_scroll_load(){return!arrPageContent.scroll_block_disabled&&(!arrPageContent.full&&void(arrPageContent.scroll_nav?0==$(document).find(arrPageContent.scroll_block).scrollTop()&&(arrPageContent.from=parseInt(arrPageContent.from)+parseInt(arrPageContent.limit),content_loader_load("continue")):parseInt($(document).find(arrPageContent.scroll_block).height())+parseInt($(document).find(arrPageContent.scroll_block).scrollTop())>=$(document).find(arrPageContent.scroll_block).prop("scrollHeight")-100&&(arrPageContent.from=parseInt(arrPageContent.from)+parseInt(arrPageContent.limit),content_loader_load("continue"))))}function content_loader_load(e){arrPageContent.scroll_block_disabled=!0,$(document).find(arrPageContent.scroll_block).addClass("_no_scroll_"),$.when(content_download({action:arrPageContent.table,form:arrPageContent.form,parents:arrPageContent.parents,from:arrPageContent.from,sort:arrPageContent.sort,sortdir:arrPageContent.sortdir,limit:arrPageContent.limit},"text",!1)).then(function(t){if(!t)return!1;var a=$.parseJSON(t),r="";if(a.length){arrPageParams.scroll_nav&&(a=a.reverse()),$.each(a,function(e,t){r+=content_loader_elem_html(t)}),arrPageParams.scroll_nav?($(document).find(arrPageContent.content_selector).prepend(r),a=a.reverse()):$(document).find(arrPageContent.content_selector).append(r);var n=0;$.each(a,function(t,r){setTimeout(function(){arrPageContent.elem_show_class?$(document).find(arrPageContent.content_selector).find('._elem[data-id="'+r.id+'"]').addClass(arrPageContent.elem_show_class):$(document).find(arrPageContent.content_selector).find('._elem[data-id="'+r.id+'"]').addClass("_show_")},150*n/2),a.length==n+1&&content_loader_scroll_to(e),n++}),a.length<10&&(arrPageContent.full=!0,$(document).find(arrPageContent.scroll_block).removeClass("_no_scroll_"),$(document).find(arrPageContent.scroll_block).removeClass("_scroll_"))}else arrPageContent.full=!0,$(document).find(arrPageContent.scroll_block).removeClass("_no_scroll_"),$(document).find(arrPageContent.scroll_block).removeClass("_scroll_")})}function content_loader_add(e){var t=content_loader_elem_html(e);arrPageParams.scroll_nav?$(document).find(arrPageContent.content_selector).append(t):$(document).find(arrPageContent.content_selector).prepend(t),setTimeout(function(){arrPageContent.elem_show_class?$(document).find(arrPageContent.content_selector).find('._elem[data-id="'+e.id+'"]').addClass(arrPageContent.elem_show_class):$(document).find(arrPageContent.content_selector).find('._elem[data-id="'+e.id+'"]').addClass("_show_")},150)}function content_loader_update(e){var t=content_loader_elem_html(e);$(document).find(arrPageContent.content_selector).find('._elem[data-id="'+e.id+'"]').addClass("_update_").after(t),$(document).find(arrPageContent.content_selector).find('._elem[data-id="'+e.id+'"]._update_').remove(),setTimeout(function(){arrPageContent.elem_show_class?$(document).find(arrPageContent.content_selector).find('._elem[data-id="'+e.id+'"]').addClass(arrPageContent.elem_show_class):$(document).find(arrPageContent.content_selector).find('._elem[data-id="'+e.id+'"]').addClass("_show_")},150)}function content_loader_del(e){$(document).find(arrPageContent.content_selector).find('._elem[data-id="'+e.id+'"]').hide("slow"),setTimeout(function(){$(document).find(arrPageContent.content_selector).find('._elem[data-id="'+e.id+'"]').remove()},150)}function content_loader_scroll_to(e){var t=$(document).find(arrPageContent.scroll_block).prop("scrollHeight"),a=t-arrPageContent.scroll_block_height;arrPageContent.scroll_block_height=t,$(document).find(arrPageContent.scroll_block).removeClass("_no_scroll_"),arrPageContent.scroll_block_disabled=!1,"start"==e&&(arrPageContent.scroll_nav?$(document).find(arrPageContent.content_selector).on("load",scroll_to(0,t,180,$(document).find(arrPageContent.scroll_block))):$(document).find(arrPageContent.content_selector).on("load",scroll_to(0,0,180,$(document).find(arrPageContent.scroll_block)))),"continue"==e&&scroll_to(0,a,0,$(document).find(arrPageContent.scroll_block))}function content_loader_elem_html(e,t){t=t||arrPageContent.oTemplate;var a=[],r=[],n=$(t)[0].innerHTML;for(var o in e)if(a.push(o),r.push(e[o]),"object"==typeof e[o]){arrPageContent.arrayObjects[e.id]||(arrPageContent.arrayObjects[e.id]=[]),arrPageContent.arrayObjects[e.id][o]=e[o];for(var l in e[o])a.push(o+"."+l),r.push(e[o][l])}for(var s=0;s<a.length;s++)n=n.split("{{"+a[s]+"}}").join(r[s]);return n=n.replace(/{{(.*?)}}/g,"")}$.fn.content_loader=function(){arrPageParams.table=this.data().content_loader_table,arrPageParams.form=this.data().content_loader_form,arrPageParams.from=this.data().content_loader_from,arrPageParams.limit=this.data().content_loader_limit,arrPageParams.sort=this.data().content_loader_sort,arrPageParams.sortdir=this.data().content_loader_sortdir,arrPageParams.scroll_block=this.data().content_loader_scroll_block,arrPageParams.scroll_nav=this.data().content_loader_scroll_nav,arrPageParams.parents=this.data().content_loader_parents,arrPageParams.content_selector="#"+this.attr("id"),arrPageParams.elem_show_class=this.data().content_loader_show_class,arrPageParams.elem_template_path=this.data().content_loader_template,arrPageParams.elem_template_selector=this.data().content_loader_template_selector,arrPageContent.arrayObjects=[],content_loader_init()},$(function(){$(document).on("click",".content_loader_show",function(){return $.when(content_download({action:$(this).data().action,form:$(this).data().form,parents:$(this).data().parents,id:$(this).data().id},"json")).then(function(e){e.form&&$.fancybox.open(e.form)}),!1}),$(document).on("submit","form#content_loader_save",function(){var e=$(this).serializeArray();return $.when(content_download(e,"json")).then(function(e){e.success&&(e.success.text?status(e.success.text):status(e.success),e.success.event,e.success.location&&$(location).attr("href",e.success.location)),e.error&&status(e)}),!1}),$(document).on("click",".content_loader_del",function(){if(!$(this).data().elem)return status({error:"Не указан селектор элемента для удаления"}),!1;var e=$(this).parents($(this).data().elem);return!!confirm("Вы действительно хотите удалить этот элемент?")&&($.when(content_download({action:$(this).data().action,form:$(this).data().form,id:$(this).data().id},"json")).then(function(t){t.success?e.remove():$.fancybox.open('<p class="error">'+t.error+"</p>")}),!1)})});